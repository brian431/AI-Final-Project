from mtcnn import MTCNN
import keras
from keras_vggface.vggface import VGGFace
from keras_vggface.utils import preprocess_input
from keras_vggface.utils import decode_predictions
import PIL
import os
from urllib import request
import numpy as np
import cv2
from flask import url_for

def recognize():
    print('hi')
    url = url_for('static', filename = 'image.png', _scheme = 'https')
    # url = 'data:image/jpeg;base64,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'
    # Open the link and save the image to res
    print('hi')
    res = request.urlopen(url)
    # Read the res object and convert it to an array
    print('hi')
    img = np.asarray(bytearray(res.read()), dtype='uint8')
    
    # Add the color variable
    print('hi')
    img = cv2.imdecode(img, cv2.IMREAD_COLOR)
    # Show the image
    # cv2.imshow(img)
    print('hi')
    # Initialize mtcnn detector
    detector = MTCNN()
    # set face extraction parameters
    target_size = (224,224) # output image size
    border_rel = 0 # increase or decrease zoom on image
    print('hi')
    # detect faces in the image
    detections = detector.detect_faces(img)
    if len(detections) == 0:
        return ''
    print('hi')

    x1, y1, width, height = detections[0]['box']
    dw = round(width * border_rel)
    dh = round(height * border_rel)
    x2, y2 = x1 + width + dw, y1 + height + dh
    face = img[y1:y2, x1:x2]

    # resize pixels to the model size
    face = PIL.Image.fromarray(face)
    face = face.resize((224, 224))
    face = np.asarray(face)
    # show face
    # cv2_imshow(face)

    # convert to float32
    face_pp = face.astype('float32')
    face_pp = np.expand_dims(face_pp, axis = 0)

    face_pp = preprocess_input(face_pp, version = 2)

    # Create the resnet50 Model
    model = VGGFace(model= 'resnet50')
    # Check what the required input of the model is & output
    # print('Inputs: {input}'.format(input = model.inputs))
    # print('Output: {output}'.format(output = model.outputs))
    # predict the face with the input
    prediction = model.predict(face_pp)

    # convert predictions into names & probabilities
    results = decode_predictions(prediction)
    # Display results
    # cv2_imshow(img)
    return results[0][0][0][results[0][0][0].index(' ') + 1: -1]

if __name__ == '__main__':
    recognize()